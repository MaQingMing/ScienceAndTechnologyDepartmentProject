<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="common/apply_header :: head"></head>
<style type="text/css">
    input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none}
    *{margin:0 auto;padding:0px}
    #app{display:flex;flex-direction:column;align-items:center;justify-content:center}
    .uploaddiv{margin-left:10px;margin-top:5px;float:left}
    .tstitle{margin-top:10px;float:left;width:140px;font-size:15px;font-weight:bold;color:#4c4c4c}
    .inputstyle{width:410px;float:left}
    .infostyle{float:left;margin-top:10px}
    .cf-title{text-align:center;font-weight:bold;font-size:14px;margin-top:10px;color:#535353}
</style>
<body>
<!-- 主页面 -->
<div id="app" v-cloak>
    <div class="Contentfilling">
        <div style="width: 100%;margin-top: 5px;">
            <div th:insert="~{common/apply/apply_tabs :: copytabs}"></div>
        </div>
        <div style="width: 99%;margin-top: 0px" v-for="(item, index) in editableTabs">
            <el-collapse v-model="item.activeName" accordion v-if="editableTabsValue == item.name">
                <el-collapse-item name="1">
                    <template slot="title">
                        <div class="cf-title" style="width: 99%">
                            <el-tooltip class="item" effect="dark" content="*为必填项" placement="top">
                                <p style="">基本信息/材料上传</p>
                            </el-tooltip>
                        </div>
                    </template>
                    <div style="margin-top: 5px;width: 90%;margin-left: 5%;">
                        <div class="infostyle">
                            <div class="tstitle">
                                <p><a style="color:#ff557f;">*</a>项目名称:</p>
                            </div>
                            <div class="inputstyle" style="width: 960px;margin-left: -50px" >
                                <el-input id="input-xmname" v-model="item.xmname" placeholder="请输入项目名称"  ></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p><a style="color:#ff557f;">*</a>项目编号:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.identifier" placeholder="请输入项目编号"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p><a style="color:#ff557f;">*</a>项目文号:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -58px">
                                <el-input v-model="item.file" placeholder="请输入文号"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p><a style="color:#ff557f;">*</a>项目性质:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.type" placeholder="请输入项目性质"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p><a style="color:#ff557f;">*</a>批准部门:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -58px">
                                <el-input v-model="item.dept" placeholder="请输入批准部门"
                                          @change="showtopart2btn=true"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>高校名称:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.school" @change="showtopart2btn=true"
                                          placeholder="请输入高校名称"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>学科门类:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -58px">
                                <el-input v-model="item.subjectCategory" @change="showtopart2btn=true"
                                          placeholder="请输入学科门类"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>承担单位:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.bearUnit" @change="showtopart2btn=true"
                                          placeholder="请输入承担单位"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>学科分类:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -58px">
                                <el-input v-model="item.subjectType" @change="showtopart2btn=true"
                                          placeholder="请输入学科分类"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>所属单位:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.belongUnit" @change="showtopart2btn=true"
                                          placeholder="请输入所属单位"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>项目状态:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -58px;width: 410px;">
                                <el-select style="width: 410px;" v-model="item.projectStatus"
                                           placeholder="请选择项目状态">
                                    <el-option
                                            v-for="item in status"
                                            :label="item"
                                            :value="item">
                                    </el-option>
                                </el-select>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>总经费(万元):</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -40px">
                                <el-input style="width: 400px" v-model="item.totalFund" type="number" @change="showtopart2btn=true"
                                          placeholder="请输入总经费(单位:万元)"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>到账总经费(万元):</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -10px; width: 350px">
                                <el-input v-model="item.receiptTotalFund" type="number"
                                          placeholder="请输入到账总经费(单位:万元)"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>申报日期:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-date-picker
                                        style="width: 410px"
                                        v-model="item.declareApproveTime"
                                        align="right"
                                        type="date"
                                        placeholder="请选择项目申报批准时间"
                                        value-format="yyyy-MM-dd">
                                </el-date-picker>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle">
                                <p>国民经济行业分类:</p>
                            </div>
                            <div class="inputstyle" style="width: 360px">
                                <el-input v-model="item.nationalEconomyCategory" @change="showtopart2btn=true"
                                          placeholder="请输入国民经济行业分类"></el-input>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>开始时间:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-date-picker
                                        style="width: 410px"
                                        v-model="item.startTime"
                                        align="right"
                                        type="date"
                                        placeholder="请选择项目开始时间"
                                        value-format="yyyy-MM-dd">
                                </el-date-picker>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>计划完成时间:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -28px; width: 380px;">
                                <el-date-picker
                                        style="width: 380px"
                                        v-model="item.planFinishTime"
                                        align="right"
                                        type="date"
                                        placeholder="请选择项目计划完成时间"
                                        value-format="yyyy-MM-dd">
                                </el-date-picker>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle">
                                <p>立项年度:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -50px">
                                <el-input v-model="item.startProjectYear" @change="showtopart2btn=true"
                                          placeholder="请输入立项年度"></el-input>
                            </div>
                        </div>
                        <div class="infostyle" style="margin-left: 50px;height: 40px">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>完成日期:</p>
                            </div>
                            <div class="inputstyle" style="margin-left: -48px">
                                <el-date-picker
                                        style="width: 400px"
                                        v-model="item.completeTime"
                                        align="right"
                                        type="date"
                                        placeholder="请选择项目完成日期"
                                        value-format="yyyy-MM-dd">
                                </el-date-picker>
                            </div>
                        </div>
                        <div class="infostyle">
                            <div class="tstitle" style="margin-left: 8px;">
                                <p>备注:</p>
                            </div>
                            <div class="inputstyle" style="width: 960px;margin-left: -58px;">
                                <el-input v-model="item.remarks" placeholder="请输入备注"></el-input>
                            </div>
                        </div>
                        <div class="cf-title" style="float: left;width: 100%;">
                            <i class="el-icon-info" style="margin-left: -80px;"></i>
                            <el-tooltip class="item" effect="dark"
                                        content="*能上传多个jpg/png/pdf/doc/docx文件，且不超过15MB"
                                        placement="top">
                                <p style="margin-top: -20px;">文件上传</p>
                            </el-tooltip>
                        </div>
                        <div class="uploaddiv">
                            <el-upload
                                    list-type="text"
                                    class="upload-demo"
                                    drag
                                    :auto-upload="false"
                                    :on-change="handleChangeFile"
                                    :on-remove="handleRemove"
                                    accept=".pdf,.jpg,.doc,.png,.docx"
                                    ref="upload"
                                    action="#"
                                    :file-list="editableTabs[editableTabsValue].fileList"
                                    multiple>
                                <i class="el-icon-upload"></i>
                                <div class="el-upload__text" style="font-weight: bold">
                                    <div>
                                        将文件拖到此处，或<em>点击上传</em>
                                    </div>
                                    <div>
                                        能上传多个jpg/png/pdf/doc/docx文件，且不超过15MB
                                    </div>
                                </div>
                                <!-- <div class="el-upload__tip"  slot="tip">*能上传多个jpg/png/pdf文件，且不超过500kb</div> -->
                            </el-upload>
                        </div>
                    </div>

                </el-collapse-item>
                <el-collapse-item name="2">
                    <template slot="title">
                        <div class="cf-title" style="width: 99%">
                            <el-tooltip class="item" effect="dark" content="按与我校签订的单个横向合同统计,依据超额累计计算法" placement="top">
                                <p style="">类别选择</p>
                            </el-tooltip>
                        </div>
                    </template>
                    <transition name="el-zoom-in-bottom">
                        <div style="width: 95%;margin-left: 2%;">
                            <el-table :data="tableData" highlight-current-row :ref="'tb' + index"
                                      @selection-change="handleSelectionChange" highlight-selection-row
                                      @row-click="handleCurrentChange" height="500" style="width: 100%">
                                <el-table-column type="selection"></el-table-column>
                                <el-table-column prop="lname" label="项目级别" width="180"></el-table-column>
                                <el-table-column prop="context" label="项目类别" width="720"></el-table-column>
                                <el-table-column prop="declareScore" label="申报分数"></el-table-column>
                                <el-table-column prop="foundScore" label="立项分数"></el-table-column>
                            </el-table>
                            <div style="width: 90%;margin-left: 5%;">
                                <el-row style="margin: 15px 0;">
                                    <el-col :span="2">
                                        <div class="tstitle">
                                            <p>项目附则:</p>
                                        </div>
                                    </el-col>
                                    <el-col :span="20">
                                        <div class="inputstyle" style="width: 100%;">
                                            <el-select style="width: 100%;" v-model="editableTabs[editableTabsValue].additional" filterable clearable
                                                       default-first-option placeholder="请选择项目附则"
                                                       @change="changeAdditional">
                                                <el-option v-for="item in additionals" :key="item.rid" :label="item.content"
                                                           :value="item.content">
                                                </el-option>
                                            </el-select>
                                        </div>
                                    </el-col>
                                </el-row>

                                <el-row style="margin-bottom: 15px;">
                                    <el-col :span="2">
                                        <div class="tstitle">
                                            <p><a style="color:#ff557f;">*</a>项目阶段:</p>
                                        </div>
                                    </el-col>
                                    <el-col :span="7">
                                        <div class="inputstyle">
                                            <el-select style="width: 70%" v-model="editableTabs[editableTabsValue].selectedStage" multiple filterable
                                                       default-first-option placeholder="请选择项目阶段(可多选)"
                                                       @change="changeStage">
                                                <el-option v-for="item in stages" :key="item.name"
                                                           :label="item.name" :value="item.name">
                                                </el-option>
                                            </el-select>
                                        </div>
                                    </el-col>

                                    <el-col :span="3">
                                        <div class="tstitle" style="text-align: center;">
                                            <p>添加备案:</p>
                                        </div>
                                    </el-col>
                                    <el-col :span="7">
                                        <div class="inputstyle">
                                            <el-select v-model="item.recordid" filterable style="width: 70%"
                                                       default-first-option placeholder="请选择项目备案(请先选择主持人)" @change="changeRecord">
                                                <el-option v-for="record in Recordoptions" :key="record.id" :label="record.name"
                                                           :value="record.id">
                                                </el-option>
                                            </el-select>
                                        </div>
                                    </el-col>
                                </el-row>

                                <el-row style="margin-bottom: 15px;">
                                    <el-col :span="3">
                                        <div class="tstitle">
                                            <p><a style="color:#ff557f;">*</a>团队/个人:</p>
                                        </div>
                                    </el-col>
                                    <el-col :span="7">
                                        <div class="inputstyle">
                                            <el-radio-group v-model="item.team">
                                                <el-radio-button label="0">个人</el-radio-button>
                                                <el-radio-button label="1">团队</el-radio-button>
                                            </el-radio-group>
                                        </div>
                                    </el-col>

                                    <el-col :span="2">
                                        <div class="tstitle" v-if="item.team == 0">
                                            <p><a style="color:#ff557f;">*</a>申请人:</p>
                                        </div>
                                    </el-col>
                                    <el-col :span="7">
                                        <div class="inputstyle" v-if="item.team == 0" style="width: 287px;">
                                            <el-select style="width: 100%;" v-model="editableTabs[editableTabsValue].people" filterable key="id"
                                                       :filter-method="inputQuery" @change="queryRecord" value-key="nickname"
                                                       default-first-option placeholder="请输入或选择成员">
                                                <el-option v-for="user in searchedUsers" :key="user.id"
                                                           :label="user.nickname + ' ' + user.username" :value="user">
                                                </el-option>
                                            </el-select>
                                        </div>

                                        <div class="infostyle" v-if="item.team == 1" style="margin-top: -1px;" id="cdfp">
                                            <el-button type="primary" @click="pdlory" style="width: 260px" plain>选择成员与分数分配</el-button>
                                        </div>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>
                    </transition>
                    <el-dialog :visible.sync="editableTabs[editableTabsValue].dialogVisible" width="760px" :before-close="handleClose" center>
                        <div>
                            <div style="font-size: 15px;color: #4c4c4c;font-weight: bold;margin-top: -35px;">
                                <p style="">当前您可分配的分数为：<a style="color: #0081fe;">{{ editableTabs[editableTabsValue].showfs }}</a></p>
                            </div>
                            <div class="cytitle" style="margin-top: 10px;">
                                <div style="float: left;margin-left: 20%;"><p>姓名</p></div>
                                <div style="float: left;margin-left: 29%;"><p>分数</p></div>
                                <el-button type="primary" size="mini" style="float: left;margin-left: 200px;margin-top: -5px;" @click="addpeople">添加</el-button>
                            </div>
                            <div style="position: absolute;top: 90px;font-weight: bold;"><a>主持人</a></div>
                            <div style="width: 90%;margin-left: 5%;float: left;padding-bottom: 10px;" v-for="(item,index) in editableTabs[editableTabsValue].peoples">
                                <div class="inputstyle" style="width: 220px;margin-left: 20px;margin-top: 10px;">
                                    <el-select style="width: 100%;" v-model="item.user" filterable :filter-method="inputQuery" :key="'id' + index"
                                               value-key="nickname" @change="selectedUser" default-first-option placeholder="请输入姓名">
                                        <el-option v-for="user in searchedUsers" :key="user.id"
                                                   :label="user.nickname + ' ' + user.username" :value="user">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div class="inputstyle" style="width: 210px;margin-left: 20px; margin-top: 10px;">
                                    <el-input v-model="item.score"  placeholder="请输入分数" @input="losefs(item.score, item)"></el-input>
                                </div>
                                <div style="float: left;margin-top: 15px;margin-left: 100px;">
                                    <el-button type="danger" plain size="small" @click="deleteone(index)">删除</el-button>
                                </div>
                            </div>
                        </div>
                        <span slot="footer" class="dialog-footer">
                            <el-button type="primary" size="small" style="border-radius: 5px;" @click="cmfs()">确 定</el-button>
                        </span>
                    </el-dialog>
                </el-collapse-item>
            </el-collapse>
        </div>
    </div>
    <div class="bottomcard" style="margin-bottom: 5px;"  th:insert="~{common/apply/apply_bottom :: copybottom}"></div>
</div>
<!--js-->
<script type="text/javascript">
    new Vue({
        el: "#app",
        data: {
            user: {}, // 登录用户信息
            applyPageName:'纵向科研',
            chinesedata:['一','二','三','四','五','六'],// 中文数字
            card1: true, // 是否显示基础信息卡
            card2: false, // 是否显示选择项目类别卡
            card3: false, // 是否显示提交卡
            active: "1", // 进度条参数
            records: [], // 被选中的备案
            showtopart2btn: false, // 是否显示基础信息下一步按钮
            showtopart3btn: false, // 是否显示类别选择卡片的下一步按钮
            qr: false,// 是否确认信息填写完毕
            // 选择项目备案列表
            Recordoptions: [],
            tableData: [],
            // 选择申请人列表
            searchedUsers: [],
            // 项目阶段
            stages: [
                {name: "申报"},
                {name: "立项"}
            ],
            // 附则信息
            additionals: [],
            editableTabs: [{
                title: '新建申报一',
                name: 0,
                trtid: "", //项目类型id
                type: "",// 项目性质
                file: "",// 项目文号
                identifier: "", // 项目编号
                dept: "", // 批准部门
                sid: "", //申请人id
                xmname: "", // 项目名称
                recordid: "", // 项目备案
                remarks: "", // 项目备注
                leid: "", // 项目级别
                firstSign: "1", // 学校署名
                childid: "", // standardid
                stage: "", // 项目阶段
                // 被选中的附则
                additional: "",
                content: "", // 附则信息
                ratio: 1, // 计算比率
                scoreType: "", // 附则类型
                score: 0,
                declareScore: 0, // 申报分数
                foundScore: 0, // 立项分数
                team: "0", // 团队还是个人
                scoreInfo: "", // 分配详情
                declareApproveTime: "", // 申报批准时间
                startTime: "", // 开始时间
                planFinishTime: "", // 计划完成时间
                completeTime: "", // 完成日期
                school: "湖南工学院", // 高校名称
                subjectCategory: "", // 学科门类
                startProjectYear: "", // 立项年度
                belongUnit: "", // 所属单位
                totalFund: 0, // 总经费
                receiptTotalFund: 0, // 到账总经费
                bearUnit: "", // 承担单位
                subjectType: "", // 学科分类
                nationalEconomyCategory: "", // 国民经济行业分类
                selectedStage: [],
                activeName: '1',// 折叠面板参数
                peoples: [],   // 团队人员
                showfs: 0,// 用于显示的分数
                xmfs: 0, // 项目总分
                dialogVisible: false,// 是否显示成员选择与分数分配弹窗
                standbyffs:0,//备用分数用于 减分后 分数不够问题
                // 文件列表
                fileList: [],
                size: 0,
                currentRow: {}, // 当前选中的行
                // 申请人
                people: {
                    id: "",
                    nickname: ""
                },
            }], // 申报列表
            editableTabsValue: '0',//标签页默认选中
            tabIndex: 0,//当前标签的下标
            selectedUsers: [], // 被选中过的申请人
            allSuccess: true,
            lname: "", // 选中的级别内容
            recordName: "", // 被选中的备案名称
            scoringFlag: true, // 判断是否修改计分选项
            lastMaster: {
                id: ""
            },
            status: ["进行", "完成", "暂停", "撤销"], // 项目状态
            pickerOptions: {
                disabledDate(time) {
                    return time.getTime() > Date.now();
                },
                shortcuts: [{
                    text: '今天',
                    onClick(picker) {
                        picker.$emit('pick', new Date());
                    }
                }, {
                    text: '昨天',
                    onClick(picker) {
                        const date = new Date();
                        date.setTime(date.getTime() - 3600 * 1000 * 24);
                        picker.$emit('pick', date);
                    }
                }, {
                    text: '一周前',
                    onClick(picker) {
                        const date = new Date();
                        date.setTime(date.getTime() - 3600 * 1000 * 24 * 7);
                        picker.$emit('pick', date);
                    }
                }]
            },
            isChecked: false,

        },
        filters: {
            // 截取显示的字体
            subString(value) {
                // ["aaa","aaa"]
                var res = value
                return res
            },
            subString2(value) {
                // ["aaa","aaa"]
                var res = value.toString()
                if (!res) return "无";
                return res
            },
            subString3(value) {
                // ["aaa","aaa"]
                var res = "个人"
                if (value == 1) {
                    res = "团体"
                }
                return res
            },
            subString4(value) {
                // ["aaa","aaa"]
                var res = value.category
                return res
            },
            subString5(value) {
                if (!value) return "无";
                return value;
            }
        },
        created() {
            this.user = JSON.parse(sessionStorage.getItem("user"));
            this.editableTabs[this.editableTabsValue].people = this.user.user;
            this.searchedUsers[0] = this.user.user;
            this.selectedUsers.push(this.user.user);
            this.getLevel();
        },
        mounted() {
            this.editableTabs[this.editableTabsValue].peoples[0] = {}
            this.editableTabs[this.editableTabsValue].peoples[0].user = {}
            this.editableTabs[this.editableTabsValue].peoples[0].user = this.user.user;
            this.editableTabs[this.editableTabsValue].peoples[0].score = 0;
            document.getElementById("input-xmname").focus();
        },
        methods: {
            // 将选中的申请人放入搜索中
            selectedUser(value) {
                this.$forceUpdate();
                // 过滤重复的元素
                for (let i = 0; i < this.selectedUsers.length; i++) {
                    if (this.selectedUsers[i].username == value.username) {
                        return;
                    }
                }
                this.selectedUsers.push(value);
            },
            // 是否能够提交
            async isSubmit() {
                var can = 1;// 0为不可提交 1为可提交
                var errortext = ""
                this.editableTabs.forEach((item, index) => {
                    if (!item.xmname) {
                        errortext = errortext + item.title + '的项目名称，';
                        can = 0;
                    }
                    if (!item.identifier) {
                        errortext = errortext + item.title + '的项目编号，';
                        can = 0;
                    }
                    if (!item.file) {
                        errortext = errortext + item.title + '的项目文号，';
                        can = 0;
                    }
                    if (!item.type) {
                        errortext = errortext + item.title + '的项目性质，';
                        can = 0;
                    }
                    if (!item.dept) {
                        errortext = errortext + item.title + '的批准部门，';
                        can = 0;
                    }
                    if (!item.stage) {
                        errortext = errortext + item.title + '的项目阶段，';
                        can = 0;
                    }
                    if (item.peoples.length <= 0) {
                        errortext = errortext + item.title + '的申请人，';
                        can = 0;
                    }
                    if (item.showfs != 0) {
                        errortext = errortext + item.editableTabs[this.editableTabsValue].showfs + '的分数未分配，';
                        can = 0;
                    }
                })

                if (can == 0) {
                    this.$notify({title: '温馨提示', message: '系统检测您有以下信息未进行填写：' + errortext + '请填写后再进行提交。', position: 'top-left', type: 'error'});
                    return false;
                }
                return true;
            },
            handleTabsEdit(currentName, action) {
                const _this = this;
                //添加标签页
                if (currentName === 'add') {
                    if ((_this.editableTabs.length) <= 5) {
                        let newTabIndex = ++_this.tabIndex + '';
                        _this.editableTabs.push({
                            title: '新建申报' + this.chinesedata[_this.tabIndex], name: newTabIndex,
                            trtid: "", //项目类型id
                            type: "",// 项目性质
                            file: "",// 项目文号
                            identifier: "", // 项目编号
                            dept: "", // 批准部门
                            sid: "", //申请人id
                            xmname: "", // 项目名称
                            recordid: "", // 项目备案
                            remarks: "", // 项目备注
                            leid: "", // 项目级别
                            firstSign: "1", // 学校署名
                            childid: "", // standardid
                            stage: "", // 项目阶段
                            // 被选中的附则
                            additional: "",
                            content: "", // 附则信息
                            ratio: 1, // 计算比率
                            scoreType: "", // 附则类型
                            score: 0,
                            declareScore: 0, // 申报分数
                            foundScore: 0, // 立项分数
                            team: "0", // 团队还是个人
                            scoreInfo: "", // 分配详情
                            declareApproveTime: "", // 申报批准时间
                            startTime: "", // 开始时间
                            planFinishTime: "", // 计划完成时间
                            completeTime: "", // 完成日期
                            school: "湖南工学院", // 高校名称
                            subjectCategory: "", // 学科门类
                            startProjectYear: "", // 立项年度
                            belongUnit: "", // 所属单位
                            totalFund: 0, // 总经费
                            receiptTotalFund: 0, // 到账总经费
                            bearUnit: "", // 承担单位
                            subjectType: "", // 学科分类
                            nationalEconomyCategory: "", // 国民经济行业分类
                            selectedStage: [],
                            activeName: '1',// 折叠面板参数
                            peoples: [],   // 团队人员
                            showfs: 0,// 用于显示的分数
                            xmfs: 0, // 项目总分
                            dialogVisible: false,// 是否显示成员选择与分数分配弹窗
                            standbyffs:0,//备用分数用于 减分后 分数不够问题
                            // 文件列表
                            fileList: [],
                            size: 0,
                            currentRow: {}, // 当前选中的行
                            // 申请人
                            people: {
                                id: "",
                                nickname: ""
                            },
                        });
                        _this.editableTabsValue = newTabIndex;
                        _this.editableTabs[_this.editableTabsValue].peoples[0] = {}
                        _this.editableTabs[_this.editableTabsValue].peoples[0].user = {}
                        _this.editableTabs[_this.editableTabsValue].peoples[0].user = this.user.user;
                        _this.editableTabs[_this.editableTabsValue].peoples[0].score = 0
                        _this.editableTabs[_this.editableTabsValue].people = _this.user.user;
                        // _this.editableTabs[_this.editableTabsValue].currentRow = _this.tableData[0];
                        _this.editableTabs[_this.editableTabsValue].trtid = _this.tableData[0].trid;
                    } else {
                        _this.$notify({
                            title: '温馨提示',
                            dangerouslyUseHTMLString: true,
                            message: '<p style="margin-top: -5px;font-weight: bold">一次只能申请6个!</p>',
                            position: 'top-left'
                        });
                    }
                    return false;
                } else {
                    setTimeout(tmp => {
                        let tb = _this.$refs['tb' + currentName][0];
                        tb.selection.push(_this.editableTabs[currentName].currentRow);
                        if (tb.selection.length > 0) {
                            tb.toggleRowSelection(tb.selection.pop())
                        }
                        _this.editableTabsValue = currentName;
                    }, 100)
                }
            },
            // 删除标签页
            removeTab(targetName) {
                const _this = this;
                //删除标签页
                if (_this.editableTabs.length <= 1) {
                    _this.$notify({
                        title: '温馨提示',
                        dangerouslyUseHTMLString: true,
                        message: '<p style="margin-top: -5px;font-weight: bold">最后一个了哦,不允许删除!</p>',
                        position: 'top-left'
                    });
                    return false;
                }
                let tabs = _this.editableTabs;
                _this.editableTabs = tabs.filter(tab => tab.name !== targetName);
                for (let i = 0; i < _this.editableTabs.length; i++) {
                    if (_this.editableTabs[i].name != i) {
                        _this.editableTabs[i].name = i + '';
                        _this.editableTabs[i].title = "新增申报" + this.chinesedata[i];
                    }
                }
                _this.editableTabsValue = _this.editableTabs[_this.editableTabs.length - 1].name;
                _this.tabIndex = (_this.editableTabs.length - 1);
            },
            // 计算分数
            async scoring() {
                if (!this.showErr()) {
                    return false;
                }
                this.editableTabs[this.editableTabsValue].score = 0;
                this.scoringFlag = false;
                axios.post("../directionApplyInfo/score", this.editableTabs[this.editableTabsValue]).then(res => {
                    if (res.data.code == 1) {
                        this.editableTabs[this.editableTabsValue].score = res.data.data;
                    } else {
                        this.$message({
                            message: "计算错误,请检查是否选择了项目级别、项目类别，是否填写经费",
                            type: "error"
                        });
                    }
                    return true;
                })
            },
            // 确定分数分配
            cmfs() {
                if (this.editableTabs[this.editableTabsValue].team == 0) {
                    return true;
                }
                let res = 0
                if (this.editableTabs[this.editableTabsValue].showfs != 0) {
                    this.$notify({
                        title: '提示',
                        message: '您还有' + this.editableTabs[this.editableTabsValue].showfs + '分未进行分配，请分配完再进行确定',
                        position: 'top-left',
                        type: 'error'
                    });
                    return false;
                } else {
                    for (let i in this.editableTabs[this.editableTabsValue].peoples) {
                        if (this.editableTabs[this.editableTabsValue].peoples[i].user.username == "" || this.editableTabs[this.editableTabsValue].peoples[i].score == "") {
                            res = 0
                            break;
                        } else {
                            res = 1
                        }
                    }
                    if (res == 0) {
                        this.$notify({title: '提示', message: '请填写完整申请人信息,再进行下一步', position: 'top-left', type: 'error'});
                        return false;
                    } else {
                        this.editableTabs[this.editableTabsValue].dialogVisible = false
                        return true;
                    }
                }
            },scoreVerificationReset(row){
                //分数验证和重置
                const _this = this;
                let tempRow = row;
                if(_this.editableTabs[_this.editableTabsValue].peoples.length <= 0){
                    if(_this.editableTabs[_this.editableTabsValue].standbyffs - Number(tempRow.value) <0){
                        _this.$notify({title: '提示', message: '您可分配的分数不足，请重新调整成员分数分配!', position: 'top-left', type: 'error'});
                        _this.editableTabs[_this.editableTabsValue].showfs = ((_this.editableTabs[_this.editableTabsValue].standbyffs - Number(tempRow.score))).toFixed(2);
                        return 1;
                    }
                }else{
                    let tmepfs = 0;
                    for (let i in _this.editableTabs[_this.editableTabsValue].peoples) {
                        tmepfs += Number(_this.editableTabs[_this.editableTabsValue].peoples[i].score);
                    }
                    let tmep = Number(tmepfs);
                    if((_this.editableTabs[_this.editableTabsValue].standbyffs - tmep) < 0){
                        _this.editableTabs[_this.editableTabsValue].showfs = (_this.editableTabs[_this.editableTabsValue].standbyffs - tmep + Number(tempRow.score) ).toFixed(2);
                        _this.$notify({title: '提示', message: '您可分配的分数不足，请重新调整成员分数分配', position: 'top-left', type: 'error'});
                        return -1;
                    }
                }
            },
            // 减去已分配分数
            losefs(value, row){

                /*if (this.editableTabs[this.editableTabsValue].showfs <= 0){
                    this.$notify({title: '提示', message: '分数已分配完，请重新输入', position: 'top-left', type: 'error'});
                    row.score = 0;
                    this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs;
                    peoples.forEach(people => {
                        this.editableTabs[this.editableTabsValue].showfs -= people.score;
                    })
                    return;
                }*/

                if (!isNaN(Number(value))) {
                    let status = this.scoreVerificationReset(row);
                    if(status == -1){
                        row.score = 0;
                        return;
                    }
                    let peoples = this.editableTabs[this.editableTabsValue].peoples;
                    for (let i = 0; i < peoples.length; i++) {
                        if (!(peoples[i].user instanceof Object)){
                            continue;
                        }
                        for (let j = 0; j < peoples.length; j++) {
                            if (i == j){
                                continue;
                            }
                            if (!(peoples[j].user instanceof Object)){
                                continue;
                            }
                            if (peoples[i].user.username == peoples[j].user.username){
                                peoples[j].score = 0;
                                this.$notify({title: '提示', message: '不可选择相同的队员', position: 'top-left', type: 'error'});
                                return;
                            }
                        }
                    }
                    if (this.editableTabs[this.editableTabsValue].showfs <= 0) {
                        this.$notify({
                            title: '提示', message: '您可分配的分数不足，请重新调整成员分数分配',
                            position: 'top-left', type: 'error'});

                        this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs
                        for (let i in this.editableTabs[this.editableTabsValue].peoples) {
                            this.editableTabs[this.editableTabsValue].showfs = (this.editableTabs[this.editableTabsValue].showfs - this.editableTabs[this.editableTabsValue].peoples[i].score).toFixed(2);
                        }
                    } else {
                        this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs
                        for (let i in this.editableTabs[this.editableTabsValue].peoples) {
                            this.editableTabs[this.editableTabsValue].showfs = (this.editableTabs[this.editableTabsValue].showfs - Number(this.editableTabs[this.editableTabsValue].peoples[i].score)).toFixed(2);
                        }
                    }
                } else {
                    this.$notify({title: '提示', message: '字数输入不正确，请输入数值（数字）',
                        position: 'top-left', type: 'error'});
                }
            },
            // 添加成员
            addpeople() {
                if (this.editableTabs[this.editableTabsValue].showfs != 0) {
                    this.editableTabs[this.editableTabsValue].peoples.push({name: "", score: 0});
                } else {
                    this.$notify({title: '提示', message: '分数已分配完不可添加成员，如想继续添加成员请调整成员分数分配',
                        position: 'top-left', type: 'error'});
                }
            },
            // 删除成员
            deleteone(index) {
                if (this.editableTabs[this.editableTabsValue].peoples.length == 1) {
                    this.$notify({title: '提示', message: '已经是最后一个人啦，必须要有一个主持人哦', position: 'top-left', type: 'error'});
                } else {
                    this.editableTabs[this.editableTabsValue].peoples.splice(index, 1)
                    this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs
                    for (let i in this.editableTabs[this.editableTabsValue].peoples) {
                        this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].showfs - Number(this.editableTabs[this.editableTabsValue].peoples[i].score);
                    }
                }
            },
            // 可分配分数初步判断与赋值
            async pdlory() {
                this.editableTabs[this.editableTabsValue].xmfs = parseInt(this.editableTabs[this.editableTabsValue].score)
                this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs
                for (let i in this.editableTabs[this.editableTabsValue].peoples){
                    this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].showfs - Number(this.editableTabs[this.editableTabsValue].peoples[i].score);
                }

                if(typeof (this.editableTabs[this.editableTabsValue].showfs) == "undefined" ||
                    this.editableTabs[this.editableTabsValue].showfs <= 0){
                    this.$notify({title: '提示', message: '可分配为 0 ,请检查是否选择了相关信息!', position: 'top-left', type: 'error'});
                    return;
                }else{
                    this.editableTabs[this.editableTabsValue].standbyffs = this.editableTabs[this.editableTabsValue].showfs;
                    this.editableTabs[this.editableTabsValue].dialogVisible = true;
                }
            },
            // 删除成员
            deleteRow(index, rows) {
                rows.splice(index, 1);
            },
            // 是否确定关闭弹窗
            handleClose(done) {
                this.$confirm('是否取消填写？').then(_ => {done();}).catch(_ => {});
                this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].xmfs
                for (let i in this.editableTabs[this.editableTabsValue].peoples) {
                    this.editableTabs[this.editableTabsValue].showfs = this.editableTabs[this.editableTabsValue].showfs - parseInt(this.editableTabs[this.editableTabsValue].peoples[i].score)
                }
            },
            // 选择阶段
            changeStage(value) {
                let stage = "";
                value.forEach(item => {
                    stage += item + ",";
                })
                this.editableTabs[this.editableTabsValue].stage = stage.substring(0, stage.length - 1);
                if (!this.editableTabs[this.editableTabsValue].currentRow){
                    this.$notify({title: '提示', message: '请选择项目级别,再进行下一步', position: 'top-left', type: 'error'});
                }else {
                    this.scoring()
                }
            },
            // 选择附则
            changeAdditional(value) {
                let flag = true;
                this.additionals.forEach(item => {
                    if (item.content == value) {
                        flag = false;
                        this.editableTabs[this.editableTabsValue].content = item.content;
                        this.editableTabs[this.editableTabsValue].scoreType = item.type;
                        this.editableTabs[this.editableTabsValue].ratio = item.ratio;
                    }
                })
                if (flag){
                    this.editableTabs[this.editableTabsValue].content = "";
                    this.editableTabs[this.editableTabsValue].scoreType = 0;
                    this.editableTabs[this.editableTabsValue].ratio = 1;
                }
                if (this.editableTabs[this.editableTabsValue].stage == ""){
                    /* this.$notify({
                         title: '提示',
                         message: '请选择项目阶段,再进行下一步',
                         position: 'top-left',
                         type: 'error'
                     });*/
                }else {
                    this.scoring()
                }
            },
            // 选择备案
            changeRecord(value) {
                this.Recordoptions.forEach(item => {
                    if (item.id == value) {
                        this.recordName = item.name;
                    }
                })
            },
            // 获取项目级别信息
            getLevel() {
                axios.get("../directionStandard/level").then(res => {
                    if (res.data.code == 1) {
                        this.tableData = res.data.data;
                        if (this.tableData) {
                            if (this.tableData.length > 0) {
                                this.editableTabs[this.editableTabsValue].trtid = this.tableData[0].trid
                                // this.editableTabs[this.editableTabsValue].currentRow = this.tableData[0]
                            }
                            this.queryRecord();
                            this.queryAdditional();
                        }
                    } else {
                        this.tableData = [];
                    }
                })
            },
            // 查询备案信息
            queryRecord() {
                if (this.editableTabs[this.editableTabsValue].team == 1) {
                    if (this.lastMaster.id == this.editableTabs[this.editableTabsValue].peoples[0].id) {
                        return;
                    } else {
                        this.lastMaster = this.editableTabs[this.editableTabsValue].peoples[0];
                    }
                } else if (this.editableTabs[this.editableTabsValue].team == 0) {
                    if (this.lastMaster.id == this.editableTabs[this.editableTabsValue].people.id) {
                        return;
                    } else {
                        this.lastMaster = this.editableTabs[this.editableTabsValue].people;
                    }
                }
                this.editableTabs[this.editableTabsValue].recordid = "";
                this.recordName = "";
                axios.get("../record/type/" + this.editableTabs[this.editableTabsValue].trtid + "/" + this.lastMaster.id).then(res => {
                    if (res.data.code == 1) {
                        this.Recordoptions = res.data.data;
                    } else {
                        this.Recordoptions = [];
                    }
                })
            },
            // 查询附则信息
            queryAdditional() {
                axios.get("../additional_rules/get/" + this.editableTabs[this.editableTabsValue].trtid).then(res => {
                    if (res.data.code == 1) {
                        this.additionals = res.data.data;
                        this.additionals.forEach(item => {
                            item.content = item.content.replace(/#\d?/, item.ratio);
                        })
                    } else {
                        this.additionals = [];
                    }
                })
            },
            // 输入下拉框时查询
            inputQuery(value) {
                // 如果数字超过5个就查询
                if (value.match(/\d{5}/)) {
                    axios.get("../gainApply/user", {
                        params: {
                            username: value
                        }
                    }).then(res => {
                        if (res.data.code == 1) {
                            // this.searchedUsers = res.data.data;
                            this.searchedUsers = res.data.data;
                            for (let i = 0; i < this.selectedUsers.length; i++) {
                                this.searchedUsers.push(this.selectedUsers[i]);
                            }
                        } else {
                            this.searchedUsers = []
                        }
                    })
                } else if (!value.match(/\d/) && value.length != 0) {
                    // 不为数字就直接通过名字查询
                    axios.get("../gainApply/user", {
                        params: {
                            nickname: value
                        }
                    }).then(res => {
                        if (res.data.code == 1) {
                            this.searchedUsers = res.data.data;
                            for (let i = 0; i < this.selectedUsers.length; i++) {
                                this.searchedUsers.push(this.selectedUsers[i]);
                            }
                        } else {
                            this.searchedUsers = []
                        }
                    })
                }
            },
            //文件上传方法ar
            handleChangeFile(file) {
                const allowedExtensions = ['jpg', 'png', 'pdf', 'doc', 'docx'];
                const fileExtension = file.name.split('.').pop();
                this.editableTabs[this.editableTabsValue].size += file.size;
                if (this.editableTabs[this.editableTabsValue].size / 1024 / 1024 < 15 && allowedExtensions.includes(fileExtension.toLowerCase())) {
                    this.editableTabs[this.editableTabsValue].fileList.push(file);
                } else {
                    if (this.editableTabs[this.editableTabsValue].size / 1024 / 1024 >= 15) {
                        this.$message({message: "文件总大小超出15MB", duration: 100000});
                    } else {
                        this.$message('不支持的文件类型');
                    }
                    // 不支持该文件，删除
                    this.handleRemove(file);
                }
            },
            // 删除文件
            handleRemove(file) {
                this.editableTabs[this.editableTabsValue].size -= file.size;
                this.editableTabs[this.editableTabsValue].fileList = this.editableTabs[this.editableTabsValue].fileList.filter((f) => file.name !== f.name)
            },
            // 是否确保信息无误与填写完整
            async handleCheckedCitiesChange() {
                if (!await this.isSubmit()) {
                    this.isChecked = false;
                    this.qr = false;
                    return;
                }
                this.qr = !this.qr
            },
            async submit() {
                for (let i = 0; i < this.editableTabs.length; i++) {
                    let params = new FormData();
                    this.editableTabs[i].fileList.forEach(file => {
                        params.append("files", file.raw);
                    })
                    this.editableTabs[i].sid = ""
                    this.editableTabs[i].scoreInfo = ""
                    if (this.editableTabs[i].team == 0) {
                        this.editableTabs[i].scoreInfo += this.editableTabs[this.editableTabsValue].people.id + "::" + this.editableTabs[i].score;
                        this.editableTabs[i].sid = this.editableTabs[this.editableTabsValue].people.id;
                    } else if (this.editableTabs[i].team == 1) {
                        this.editableTabs[i].peoples.forEach(people => {
                            this.editableTabs[i].sid += people.user.id + ",";
                            this.editableTabs[i].scoreInfo += people.user.id + "::" + people.score + ";";
                        })
                        this.editableTabs[i].sid = this.editableTabs[i].sid.substring(0, this.editableTabs[i].sid.length - 1);
                        this.editableTabs[i].scoreInfo = this.editableTabs[i].scoreInfo.substring(0, this.editableTabs[i].scoreInfo.length - 1);
                    }
                    let applyVo = {
                        trtid: this.editableTabs[i].trtid, //项目类型id
                        type: this.editableTabs[i].type,// 项目类型
                        file: this.editableTabs[i].file,// 项目文号
                        dept: this.editableTabs[i].dept, // 批准部门
                        sid: this.editableTabs[i].sid, //申请人id
                        name: this.editableTabs[i].xmname, // 项目名称
                        recordid: this.editableTabs[i].recordid, // 项目备案
                        remarks: this.editableTabs[i].remarks, // 项目备注
                        leid: this.editableTabs[i].leid, // 项目级别
                        cash: this.editableTabs[i].cash, // 能否换现
                        firstSign: this.editableTabs[i].firstSign, // 学校署名
                        childid: this.editableTabs[i].childid, // standardid
                        stage: this.editableTabs[i].stage, // 项目阶段
                        according: "纵向科技项目的科技工作量计分标准" + this.editableTabs[i].content ? "," + this.editableTabs[i].content : "", // 依据
                        content: this.editableTabs[i].content, // 附则信息
                        ratio: this.editableTabs[i].ratio, // 计算比率
                        scoreType: this.editableTabs[i].scoreType, // 附则类型
                        declareScore: this.editableTabs[i].declareScore, // 申报分数
                        foundScore: this.editableTabs[i].foundScore, // 立项分数
                        team: this.editableTabs[i].team, // 团队还是个人
                        scoreInfo: this.editableTabs[i].scoreInfo, // 分配详情
                        declareApproveTime: this.editableTabs[i].declareApproveTime, // 申报批准时间
                        startTime: this.editableTabs[i].startTime, // 开始时间
                        planFinishTime: this.editableTabs[i].planFinishTime, // 计划完成时间
                        completeTime: this.editableTabs[i].completeTime, // 完成日期
                        school: this.editableTabs[i].school, // 高校名称
                        subjectCategory: this.editableTabs[i].subjectCategory, // 学科门类
                        startProjectYear: this.editableTabs[i].startProjectYear, // 立项年度
                        identifier: this.editableTabs[i].identifier, // 项目编号
                        belongUnit: this.editableTabs[i].belongUnit, // 所属单位
                        totalFund: this.editableTabs[i].totalFund, // 总经费
                        receiptTotalFund: this.editableTabs[i].receiptTotalFund, // 到账总经费
                        bearUnit: this.editableTabs[i].bearUnit, // 承担单位
                        subjectType: this.editableTabs[i].subjectType, // 学科分类
                        nationalEconomyCategory: this.editableTabs[i].nationalEconomyCategory, // 国民经济行业分类
                    }
                    let json = JSON.stringify(applyVo)
                    params.append("applyVo", json);
                    axios.post("../directionApplyInfo/add", params, {
                        headers: {
                            "Content-Type": "multipart/form-data" // 设置请求头
                        }
                    }).then(res => {
                        if (res.data.code == 1) {
                            // 上传成功
                            this.$notify({
                                title: '',
                                dangerouslyUseHTMLString: true,
                                message: '<p style="color: #33ce0c;margin-top: -5px;font-weight: bold">提交成功！</p>',
                                position: 'top-left'
                            });
                            if (this.editableTabs.length > 1){
                                this.removeTab(i);
                            }
                        }else {
                            this.allSuccess = false;
                            this.$message({message: res.data.msg, type: "error"})
                        }
                    })
                }
            },
            async commit(row) {
                await this.submit();
                setTimeout(tmp => {
                    if (this.allSuccess){
                        window.parent.postMessage({url:"project_application/toProject_apply"}, "*");
                    }
                }, 4000)
            },
            handleSelectionChange(selection) {
                this.scoringFlag = true;
                this.editableTabs[this.editableTabsValue].currentRow = selection[0];
                let tb = this.$refs['tb' + this.editableTabsValue][0];
                if (selection.length > 1) {
                    tb.clearSelection();
                    tb.toggleRowSelection(selection.pop());
                }
                if (this.editableTabs[this.editableTabsValue].currentRow) {
                    this.lname = this.editableTabs[this.editableTabsValue].currentRow.context;
                    this.editableTabs[this.editableTabsValue].leid = this.editableTabs[this.editableTabsValue].currentRow.leid;
                    this.editableTabs[this.editableTabsValue].childid = this.editableTabs[this.editableTabsValue].currentRow.id;
                    this.editableTabs[this.editableTabsValue].cash = this.editableTabs[this.editableTabsValue].currentRow.cash;
                    this.editableTabs[this.editableTabsValue].declareScore = this.editableTabs[this.editableTabsValue].currentRow.declareScore ?
                        this.editableTabs[this.editableTabsValue].currentRow.declareScore : 0;
                    this.editableTabs[this.editableTabsValue].foundScore = this.editableTabs[this.editableTabsValue].currentRow.foundScore ?
                        this.editableTabs[this.editableTabsValue].currentRow.foundScore : 0;
                    this.showtopart3btn = true
                    this.active = 2;
                }
            },
            handleCurrentChange(selection) {
                let tb = this.$refs['tb' + this.editableTabsValue][0];
                tb.clearSelection();
                this.editableTabs[this.editableTabsValue].currentRow = selection;
                tb.toggleRowSelection(selection);
                if (this.editableTabs[this.editableTabsValue].stage){
                    this.scoring();
                }else {
                    this.editableTabs[this.editableTabsValue].score = 0;
                }
            },
            showErr() {
                if (!this.editableTabs[this.editableTabsValue].currentRow || this.editableTabs[this.editableTabsValue].stage == "") {
                    this.$notify({title: '提示', message: '请选择相应级别/阶段,再进行下一步', position: 'top-left', type: 'error'});
                    return false;
                }
                if (this.editableTabs[this.editableTabsValue].selectedStage.length <= 0 || this.editableTabs[this.editableTabsValue].currentRow == null) {
                    this.$notify({title: '提示', message: '请选择项目类别和申报/立项,再进行选择成员与分数分配',
                        position: 'top-left', type: 'error'});
                    return false;
                }
                return true;
            },
            async topart3() {
                this.editableTabs[this.editableTabsValue].sid = "";
                this.editableTabs[this.editableTabsValue].scoreInfo = "";
                this.pname = ""
                // 验证计分选项
                if (this.scoringFlag && !await this.scoring()) {
                    return;
                }
                if (!this.cmfs()) {
                    return;
                }
                if (!((this.editableTabs[this.editableTabsValue].team == 0 && this.editableTabs[this.editableTabsValue].people.id != "") || (this.editableTabs[this.editableTabsValue].team == 1 && this.editableTabs[this.editableTabsValue].peoples.length > 0))) {
                    this.$notify({title: '提示', message: '请填写完整人员信息,再进行下一步', position: 'top-left', type: 'error'});
                    return false;
                }
                if (this.editableTabs[this.editableTabsValue].team == 0) {
                    this.pname += this.editableTabs[this.editableTabsValue].people.nickname;
                    this.editableTabs[this.editableTabsValue].scoreInfo += this.editableTabs[this.editableTabsValue].people.id + "::" + this.editableTabs[this.editableTabsValue].people.score;
                    this.editableTabs[this.editableTabsValue].sid = this.editableTabs[this.editableTabsValue].people.id;
                } else if (this.editableTabs[this.editableTabsValue].team == 1) {
                    this.editableTabs[this.editableTabsValue].editableTabs[this.editableTabsValue].peoples.forEach(people => {
                        this.pname += people.user.nickname;
                        this.editableTabs[this.editableTabsValue].sid += people.user.id + ",";
                        this.editableTabs[this.editableTabsValue].scoreInfo += people.user.id + "::" + people.score + ";";
                    })
                    this.editableTabs[this.editableTabsValue].sid = this.editableTabs[this.editableTabsValue].sid.substring(0, this.editableTabs[this.editableTabsValue].sid.length - 1);
                    this.editableTabs[this.editableTabsValue].scoreInfo = this.editableTabs[this.editableTabsValue].scoreInfo.substring(0, this.editableTabs[this.editableTabsValue].scoreInfo.length - 1);
                }
                this.card2 = false
                this.card3 = true
                this.active = 3;
            },
            topart2() {
                if (this.editableTabs[this.editableTabsValue].name != "" && this.editableTabs[this.editableTabsValue].identifier != "" && this.editableTabs[this.editableTabsValue].file != "" &&
                    this.editableTabs[this.editableTabsValue].dept != "" && this.editableTabs[this.editableTabsValue].type != "") {
                    this.card1 = false
                    this.card2 = true
                    this.active = 1;
                } else {
                    this.$notify({title: '提示', message: '请检查信息是否填写完整，请填写完整并确保无误后再进行下一步。',
                        position: 'top-left', type: 'error'});
                }
            },
        }
    })
</script>
</body>
</html>